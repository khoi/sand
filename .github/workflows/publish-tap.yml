name: Publish Tap
on:
  release:
    types: [published]
env:
  HOMEBREW_NO_AUTO_UPDATE: "1"
jobs:
  bottle:
    strategy:
      matrix:
        macos:
          - macos-15
          - macos-26
    runs-on: ${{ matrix.macos }}
    steps:
      - uses: actions/checkout@v4
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"
      - run: echo "HOMEBREW_SWIFT=$(which swift)" >> "$GITHUB_ENV"
      - env:
          TAG: ${{ github.event.release.tag_name }}
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          URL="https://github.com/khoi/sand/archive/refs/tags/${TAG}.tar.gz"
          SHA=$(curl -Ls "$URL" | shasum -a 256 | awk '{print $1}')
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/khoi/homebrew-sand.git" tap
          mkdir -p tap/Formula
          cp Formula/sand.rb tap/Formula/sand.rb
          brew tap khoi/sand "$PWD/tap"
          TAP_REPO="$(brew --repo khoi/sand)"
          FORMULA_PATH="${TAP_REPO}/Formula/sand.rb"
          URL="$URL" SHA="$SHA" FORMULA_PATH="$FORMULA_PATH" python3 scripts/patch-formula-url.py
          brew install --build-from-source cirruslabs/cli/tart
          brew install --build-bottle khoi/sand/sand
          brew bottle --json --root-url "https://github.com/khoi/sand/releases/download/${TAG}" khoi/sand/sand
      - uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.macos }}
          path: |
            *.bottle*.tar.gz
            *.bottle*.json
  publish:
    needs: bottle
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      - env:
          TAG: ${{ github.event.release.tag_name }}
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          for path in artifacts/*.bottle*.tar.gz; do
            base="$(basename "$path")"
            renamed="${base/--/-}"
            if [ "$renamed" != "$base" ]; then
              mv "$path" "artifacts/$renamed"
            fi
          done
          gh release upload "${TAG}" artifacts/*.bottle*.tar.gz --clobber
          URL="https://github.com/khoi/sand/archive/refs/tags/${TAG}.tar.gz"
          SHA=$(curl -Ls "$URL" | shasum -a 256 | awk '{print $1}')
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/khoi/homebrew-sand.git" tap
          mkdir -p tap/Formula
          cp Formula/sand.rb tap/Formula/sand.rb
          brew tap khoi/sand "$PWD/tap"
          FORMULA_PATH="$(brew --repo khoi/sand)/Formula/sand.rb"
          URL="$URL" SHA="$SHA" FORMULA_PATH="$FORMULA_PATH" python3 scripts/patch-formula-url.py
          brew bottle --merge --write artifacts/*.bottle*.json
          cp "$(brew --repo khoi/sand)/Formula/sand.rb" tap/Formula/sand.rb
          git -C tap config user.name "github-actions"
          git -C tap config user.email "github-actions@github.com"
          git -C tap add Formula/sand.rb
          git -C tap commit -m "Update sand ${TAG}" || exit 0
          git -C tap remote set-url origin "https://x-access-token:${TAP_TOKEN}@github.com/khoi/homebrew-sand.git"
          git -C tap push origin main
