name: Publish Tap
on:
  release:
    types: [published]
jobs:
  bottle:
    runs-on: macos-15
    permissions:
      contents: write
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"
      - run: echo "HOMEBREW_SWIFT=$(which swift)" >> "$GITHUB_ENV"
      - env:
          TAG: ${{ github.event.release.tag_name }}
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          URL="https://github.com/khoi/sand/archive/refs/tags/${TAG}.tar.gz"
          SHA=$(curl -Ls "$URL" | shasum -a 256 | awk '{print $1}')
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/khoi/homebrew-sand.git" tap
          mkdir -p tap/Formula
          cp Formula/sand.rb tap/Formula/sand.rb
          URL="$URL" SHA="$SHA" python3 - <<'PY'
          import os
          from pathlib import Path

          url = os.environ["URL"]
          sha = os.environ["SHA"]
          path = Path("tap/Formula/sand.rb")
          lines = path.read_text().splitlines()
          filtered = []
          for line in lines:
            stripped = line.lstrip()
            if stripped.startswith("url "):
              continue
            if stripped.startswith("sha256 "):
              continue
            filtered.append(line)
          out = []
          inserted = False
          for line in filtered:
            out.append(line)
            if line.lstrip().startswith("homepage ") and not inserted:
              out.append(f'  url "{url}"')
              out.append(f'  sha256 "{sha}"')
              inserted = True
          if not inserted:
            raise SystemExit("homepage not found")
          text = "\n".join(out)
          if path.read_text().endswith("\n"):
            text += "\n"
          path.write_text(text)
          PY
          brew tap khoi/sand "$PWD/tap"
          brew install --build-bottle --build-from-source khoi/sand/sand
          brew bottle --json --root-url "https://github.com/khoi/sand/releases/download/${TAG}" khoi/sand/sand
          gh release upload "${TAG}" ./*.bottle.tar.gz --clobber
          brew bottle --merge --write ./*.bottle.json
          cp "$(brew --repo khoi/sand)/Formula/sand.rb" tap/Formula/sand.rb
          git -C tap config user.name "github-actions"
          git -C tap config user.email "github-actions@github.com"
          git -C tap add Formula/sand.rb
          git -C tap commit -m "Update sand ${TAG}" || exit 0
          git -C tap push origin main
